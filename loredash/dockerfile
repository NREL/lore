# The base image is often a plain Linux OS
# For first builds, use python:3.8.0. However, this will result in very large images
# The smaller, popular alpine base image has issues for Python builds:
#  https://pythonspeed.com/articles/alpine-docker-python/
FROM python:3.8-slim-buster
LABEL maintainer="NREL - Thermal Sciences"

# Set up the lore virtual environment
ENV VIRTUAL_ENV=/opt/app/lore

# Add a user named 'admin' for running applications only
RUN useradd -ms /bin/bash admin

# Set work directory
RUN mkdir -p /loredash

# Copy project
COPY . /loredash

# Where the code lives
WORKDIR /loredash

# Turn DEBUG mode off
RUN export DJANGO_DEBUG=False

# Set the new user as an owner of the folder in order to access the database
# TODO: find a more secure way to do this while still being able to access the db
RUN chown -R admin:admin /loredash
RUN chmod 755 /loredash

# Set environment variables
ENV PYTHONUNBUFFERED 1

# Install dependencies
RUN pip install --upgrade pip
RUN apt-get -qq update
RUN apt-get -qq install gcc
RUN pip install -r requirements.txt

# Switch to the newly created user
USER admin

CMD ["/bin/bash"]